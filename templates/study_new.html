{% extends "base.html" %}
{% block content %}
<h1>Nuevo estudio</h1>

<p>
  <strong>Paciente:</strong> {{ patient.full_name }}
  {% if patient.dni %}(DNI: {{ patient.dni }}){% endif %}
</p>

<form method="post" enctype="multipart/form-data">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="form-section">
    <h2>Datos del estudio</h2>
    <label for="study_type">Tipo de estudio</label>
    <select id="study_type" name="study_type">
      <option value="">-- Seleccionar --</option>
      {% for option in study_type_options %}
        <option value="{{ option }}">{{ option }}</option>
      {% endfor %}
    </select>

    <div class="grid-2">
      <div>
        <label for="date">Fecha del estudio</label>
        <input type="date" id="date" name="date">
      </div>
      <div>
        <label for="center_select">Centro</label>
        <select id="center_select">
          <option value="">-- Seleccionar --</option>
          {% for c in center_options %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
          <option value="__otro__">Otro</option>
        </select>
        <input type="text" id="center" name="center" placeholder="Ej: Hospital Pasteur">
        <p id="center-link"></p>
      </div>
    </div>

    <label for="description">Descripción / hallazgos</label>
    <div class="voice-field">
      <textarea id="description" name="description" rows="4"></textarea>
      <button type="button" class="btn-link btn-secondary" data-voice-btn data-target="description">Dictado</button>
    </div>

    <label for="access_code">Número de acceso</label>
    <input type="text" id="access_code" name="access_code">

    <label>Subir informe (PDF)</label>
    <input type="file" name="study_file" accept="application/pdf">
  </div>

  {% if review_users %}
  <div class="form-section">
    <h2>Solicitar revision</h2>
    <p class="form-help">Selecciona colegas para notificarles que revisen este estudio.</p>
    <label>Profesionales para revisar</label>
    <select name="review_recipients" multiple size="5">
      {% for user in review_users %}
        <option value="{{ user.id }}">{{ user.full_name }} ({{ user.specialty or 'sin especialidad' }})</option>
      {% endfor %}
    </select>
    <label>Mensaje para la revision</label>
    <div class="voice-field">
      <textarea id="review_message" name="review_message" rows="3"></textarea>
      <button type="button" class="btn-link btn-secondary" data-voice-btn data-target="review_message">Dictado</button>
    </div>
  </div>
  {% endif %}

  <button type="submit">Guardar estudio</button>
  <a class="btn-link btn-secondary" href="{{ url_for('patient_detail', patient_id=patient.id) }}">Cancelar</a>
</form>

<script>
  (function() {
    const links = {{ center_links|tojson }};
    const select = document.getElementById('center_select');
    const input = document.getElementById('center');
    const display = document.getElementById('center-link');

    function updateLink() {
      if (!input || !display) return;
      const value = (input.value || '').trim().toLowerCase();
      const url = links[value] || '';
      display.innerHTML = url ? 'Portal: <a href="' + url + '" target="_blank">' + url + '</a>' : '';
    }

    function syncCenter() {
      if (!select || !input) return;
      if (select.value && select.value !== '__otro__') {
        input.value = select.value;
        input.readOnly = true;
      } else if (select.value === '__otro__') {
        input.readOnly = false;
        input.value = '';
        input.focus();
      } else {
        input.readOnly = false;
        input.value = '';
      }
      updateLink();
    }

    if (select) {
      select.addEventListener('change', syncCenter);
      syncCenter();
    }
    if (input) {
      input.addEventListener('input', updateLink);
    }
  })();
</script>
{% endblock %}


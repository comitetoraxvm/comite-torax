{% extends "base.html" %}
{% set immuno_selected = consultation.lab_immunology|as_list %}
{% block content %}
<h1>Editar consulta</h1>

<p>
  Paciente: <strong>{{ consultation.patient.full_name }}</strong>
  (DNI: {{ consultation.patient.dni or "-" }})
</p>

<form method="post">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div class="form-section">
    <h2>Datos principales</h2>
    <label for="date">Fecha</label>
    <input type="date" id="date" name="date" value="{{ consultation.date or '' }}" required>

    <label for="notes">Notas / clinica</label>
    <div class="voice-field">
      <textarea id="notes" name="notes" rows="4">{{ consultation.notes or '' }}</textarea>
      <button type="button" class="btn-link btn-secondary" data-voice-btn data-target="notes">Dictado</button>
    </div>
  </div>

  <div class="form-section">
    <h2>Laboratorio general</h2>
    <div class="voice-field">
      <textarea id="lab_general" name="lab_general" rows="4">{{ consultation.lab_general or '' }}</textarea>
      <button type="button" class="btn-link btn-secondary" data-voice-btn data-target="lab_general">Dictado</button>
    </div>
  </div>

  <div class="form-section">
    <h2>Autoinmunidad</h2>
    <p class="form-help">Marca los paraclinicos solicitados o relevantes y carga el valor si corresponde.</p>
    {% set core_options = immuno_core_options if immuno_core_options is defined else immuno_options %}
    <div class="lab-grid">
      {% for value, label in core_options %}
        <label class="lab-row">
          <span class="lab-label">
            <input type="checkbox" name="lab_immunology" value="{{ value }}" {% if value in immuno_selected %}checked{% endif %}>
            <span>{{ label }}</span>
          </span>
          <input type="text" class="lab-input" name="lab_immunology_value_{{ value }}" placeholder="Valor" value="{{ immuno_values.get(value, '') if immuno_values else '' }}">
        </label>
      {% endfor %}
    </div>
    {% if immuno_rheum_options is defined and immuno_rheum_options %}
      <details class="lab-details">
        <summary>Desplegar panel ampliado para reumatolog√≠a</summary>
        <div class="lab-grid lab-grid--details">
          {% for value, label in immuno_rheum_options %}
            <label class="lab-row">
              <span class="lab-label">
                <input type="checkbox" name="lab_immunology" value="{{ value }}" {% if value in immuno_selected %}checked{% endif %}>
                <span>{{ label }}</span>
              </span>
              <input type="text" class="lab-input" name="lab_immunology_value_{{ value }}" placeholder="Valor" value="{{ immuno_values.get(value, '') if immuno_values else '' }}">
            </label>
          {% endfor %}
        </div>
      </details>
    {% endif %}
    <label for="lab_immunology_notes">Aclaraciones (dictado libre)</label>
    <div class="voice-field">
      <textarea id="lab_immunology_notes" name="lab_immunology_notes" rows="3">{{ consultation.lab_immunology_notes or '' }}</textarea>
      <button type="button" class="btn-link btn-secondary" data-voice-btn data-target="lab_immunology_notes">Dictado</button>
    </div>
    <style>
      .lab-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 10px 20px;
      }
      .lab-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 4px 0;
      }
      .lab-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
      }
      .lab-input {
        flex: 0 0 160px;
      }
      .lab-details {
        margin-top: 12px;
      }
      .lab-details summary {
        cursor: pointer;
        font-weight: 600;
      }
    </style>
  </div>

  <p>Si necesitas ajustar estudios vinculados, hacelo desde la seccion de Estudios.</p>

  <button type="submit">Guardar cambios</button>
  <a class="btn-link btn-secondary" href="{{ url_for('patient_detail', patient_id=consultation.patient.id) }}">Cancelar</a>
</form>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<h1>Revisiones</h1>

{% if requests %}
  <ul>
  {% for r in requests %}
    <li class="form-section" style="list-style:none;">
      <strong>Paciente:</strong>
      <a href="{{ url_for('patient_detail', patient_id=r.patient.id) }}">{{ r.patient.full_name }}</a>
      {% if r.study %}
        (Estudio ID {{ r.study.id }})
      {% elif r.consultation %}
        (Consulta ID {{ r.consultation.id }})
      {% endif %}
      <br>
      <strong>Solicitado por:</strong> {{ r.created_by.full_name }} |
      {{ r.created_at.strftime('%Y-%m-%d %H:%M') }} |
      {% set status = r.status or 'pending' %}
      {% if status == 'pending' %}
        <span style="color:#a80000; font-weight:700;">Pendiente</span>
      {% elif status == 'in_progress' %}
        <span style="color:#b58900; font-weight:700;">En proceso</span>
      {% else %}
        <span style="color:#0a7a0a; font-weight:700;">Finalizado</span>
      {% endif %}
      {% if r.resolved_at %}
        (cerrado {{ r.resolved_at.strftime('%Y-%m-%d %H:%M') }})
      {% endif %}
      {% if r.message %}
        <br><em>{{ r.message }}</em>
      {% endif %}
      {% if r.comments %}
        <div>
          <strong>Conversacion:</strong>
          <ul>
            {% for comment in r.comments | sort(attribute='created_at') %}
              <li>
                {{ comment.created_at.strftime('%Y-%m-%d %H:%M') }} -
                <strong>{{ comment.author.full_name }}:</strong>
                {{ comment.message }}
                {% if comment.author.id == current_user.id or r.created_by_id == current_user.id %}
                  | <a href="{{ url_for('review_comment_edit', comment_id=comment.id) }}">Editar</a>
                  <form method="post" action="{{ url_for('review_comment_delete', comment_id=comment.id) }}" style="display:inline;" onsubmit="return confirm('¿Borrar este comentario?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn-link btn-secondary">Borrar</button>
                  </form>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      <form method="post" action="{{ url_for('review_comment', review_id=r.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label>Agregar comentario</label>
        <div class="voice-field">
          <textarea id="comment_{{ r.id }}" name="message" rows="2"></textarea>
          <button type="button" class="btn-link btn-secondary" data-voice-btn data-target="comment_{{ r.id }}">Dictado</button>
        </div>
        <button type="submit">Enviar comentario</button>
      </form>
      {% if r.status != "resolved" %}
        <div style="margin-top:10px;">
          {% if r.status != "in_progress" %}
            <form method="post" action="{{ url_for('review_progress', review_id=r.id) }}" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn-link btn-secondary">Marcar en proceso</button>
            </form>
          {% endif %}
          <form method="post" action="{{ url_for('review_resolve', review_id=r.id) }}" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-link btn-secondary">Marcar como finalizado</button>
          </form>
        </div>
      {% endif %}
    </li>
  {% endfor %}
  </ul>
{% else %}
  <p>No tienes revisiones registradas.</p>
{% endif %}

<h2>Controles pendientes (consulta)</h2>
{% if pending_controls %}
  <ul>
    {% for c in pending_controls %}
      <li class="form-section" style="list-style:none;">
        {% set status = c.status or 'pending' %}
        <strong>Paciente:</strong>
        <a href="{{ url_for('patient_detail', patient_id=c.patient.id) }}">{{ c.patient.full_name }}</a>
        <br>
        <strong>Fecha control:</strong> {{ c.control_date or '---' }}
        <br>
        {% if status == 'pending' %}
          <span style="color:#a80000; font-weight:700;">Pendiente</span>
        {% elif status == 'in_progress' %}
          <span style="color:#b58900; font-weight:700;">En proceso</span>
        {% else %}
          <span style="color:#0a7a0a; font-weight:700;">Finalizado</span>
        {% endif %}
        {% if c.extra_emails %}<br><small>Emails extra: {{ c.extra_emails }}</small>{% endif %}
        {% if status != 'done' %}
          <form method="post" action="{{ url_for('control_reminder_progress', reminder_id=c.id) }}" style="margin-top:6px; display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-link btn-secondary">Marcar en proceso</button>
          </form>
          <form method="post" action="{{ url_for('control_reminder_complete', reminder_id=c.id) }}" style="margin-top:6px; display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-link btn-secondary">Marcar como finalizado</button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No hay controles de consulta pendientes.</p>
{% endif %}

<h2>Controles pendientes (screening)</h2>
{% if pending_followups %}
  <ul>
    {% for fu in pending_followups %}
      <li class="form-section" style="list-style:none;">
        {% set status = fu.status or 'pending' %}
        <strong>Paciente:</strong>
        <a href="{{ url_for('patient_detail', patient_id=fu.screening.patient.id) }}">{{ fu.screening.patient.full_name }}</a>
        <br>
        <strong>Tipo:</strong> {{ fu.study_type or 'Estudio' }} |
        <strong>Fecha:</strong> {{ fu.study_date or '---' }} |
        <strong>Lung-RADS:</strong> {{ fu.lung_rads or '---' }} |
        <strong>Próximo:</strong> {{ fu.next_control_date or '---' }}
        <br>
        {% if status == 'pending' %}
          <span style="color:#a80000; font-weight:700;">Pendiente</span>
        {% elif status == 'in_progress' %}
          <span style="color:#b58900; font-weight:700;">En proceso</span>
        {% else %}
          <span style="color:#0a7a0a; font-weight:700;">Finalizado</span>
        {% endif %}
        {% if fu.file_name %}
          | <a href="{{ url_for('screening_followup_file', followup_id=fu.id) }}">Archivo</a>
        {% endif %}
        {% if status != 'done' %}
          <form method="post" action="{{ url_for('screening_followup_progress', followup_id=fu.id) }}" style="margin-top:6px; display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-link btn-secondary">Marcar en proceso</button>
          </form>
          <form method="post" action="{{ url_for('screening_followup_complete', followup_id=fu.id) }}" style="margin-top:6px; display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-link btn-secondary">Marcar como finalizado</button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No hay controles de screening pendientes.</p>
{% endif %}
{% endblock %}

{% extends "base.html" %}
{% block content %}
<h1>Pacientes</h1>

<p>
  <a class="btn-link" href="{{ url_for('patient_new') }}">+ Nuevo paciente</a>
</p>

{% if is_admin %}
<form method="get" class="form-section">
  <div class="grid-2">
    <div>
      <label>Buscar por nombre, DNI o ciudad</label>
      <input type="text" name="search" value="{{ search }}">
    </div>
    <div>
      <label>Centro</label>
      <select name="center">
        <option value="">Todos</option>
        {% for c in available_centers %}
          <option value="{{ c }}" {% if center == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Ciudad</label>
      <select name="city">
        <option value="">Todas</option>
        {% for c in city_options %}
          <option value="{{ c }}" {% if city_filter == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Sexo (seleccion multiple)</label>
      <select name="sex" multiple size="3">
        {% for option in sex_options %}
          <option value="{{ option }}" {% if sex_filters and option in sex_filters %}selected{% endif %}>{{ option }}</option>
        {% endfor %}
      </select>
      <p class="form-help">Mantene Ctrl/Cmd para seleccionar varios.</p>
    </div>
    <div>
      <label>Edad minima</label>
      <input type="number" name="min_age" value="{{ min_age }}">
    </div>
    <div>
      <label>Edad maxima</label>
      <input type="number" name="max_age" value="{{ max_age }}">
    </div>
    <div>
      <label>Tabaquismo (seleccion multiple)</label>
      <div class="checkbox-grid">
        <label><input type="checkbox" name="smoking" value="smoker" {% if smoking_filters and 'smoker' in smoking_filters %}checked{% endif %}> Fumador actual</label>
        <label><input type="checkbox" name="smoking" value="former" {% if smoking_filters and 'former' in smoking_filters %}checked{% endif %}> Ex fumador</label>
        <label><input type="checkbox" name="smoking" value="never" {% if smoking_filters and 'never' in smoking_filters %}checked{% endif %}> Nunca fumador</label>
      </div>
    </div>
    <div>
      <label>Datos del paciente (antecedentes, síntomas, exposición)</label>
      <input type="text" name="patient_data_keyword" value="{{ patient_data_keyword }}" placeholder="Ej: asma, diabetes, alérgico, tabaquismo">
      <p class="form-help">Busca en antecedentes, síntomas, enfermedades autoinmunes, exposición laboral/domiciliaria.</p>
    </div>
    <div>
      <label>Estudios e imágenes (laboratorio, radiografía, etc.)</label>
      <input type="text" name="studies_keyword" value="{{ studies_keyword }}" placeholder="Ej: tomografía, laboratorio, radiografía">
      <p class="form-help">Busca en reportes de estudios, laboratorios e imágenes.</p>
    </div>
    <div>
      <label>Historial de consultas (diagnósticos, tratamientos)</label>
      <input type="text" name="consultation_keyword" value="{{ consultation_keyword }}" placeholder="Ej: neumonía, tratamiento, seguimiento">
      <p class="form-help">Busca en diagnósticos, tratamientos, evaluaciones y notas de consultas.</p>
    </div>
  </div>
  <button type="submit">Filtrar</button>
  <a class="btn-link btn-secondary" href="{{ url_for('patients_list') }}">Limpiar filtros</a>
  {% set qs = request.query_string.decode('utf-8') %}
  {% if current_user.role == 'admin' %}
    <a class="btn-link" href="{{ url_for('patients_export_summary') }}{% if qs %}?{{ qs }}{% endif %}">Exportar resumen CSV</a>
  {% endif %}
</form>
{% else %}
<form method="get" class="form-section">
  <label>Buscar por nombre o DNI</label>
  <input type="text" name="search" value="{{ search }}" placeholder="Ej: Juan Perez o 12345678">
  <button type="submit">Buscar</button>
</form>
{% endif %}

<p class="meta">Resultados: {{ patients|length }}</p>

{% if patients %}
  <ul>
    {% for p in patients %}
      <li>
        <a href="{{ url_for('patient_detail', patient_id=p.id) }}">
          {{ p.full_name }}
        </a>
        |
        DNI: {{ p.dni or '---' }}
        |
        Edad: {{ p.age or '---' }}
        |
        Centro: {{ p.center or '---' }}
        |
        {% if p.smoking_current %}
          Fumador actual
        {% elif p.smoking_previous %}
          Ex fumador
        {% else %}
          Nunca fumador
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No hay pacientes que coincidan con el filtro.</p>
{% endif %}

{% endblock %}

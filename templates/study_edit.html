{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Editar estudio</h2>
  <p><strong>Paciente:</strong> {{ study.patient.full_name }} (DNI: {{ study.patient.dni or '---' }})</p>

  <form method="post" enctype="multipart/form-data" class="mt-3">
    <div class="card">
      <div class="card-body">
        <!-- Tipo -->
        <div class="mb-3">
          <label for="study_type" class="form-label">Tipo de estudio</label>
          <select name="study_type" id="study_type" class="form-select" required>
            <option value="">-- Seleccionar --</option>
            {% for opt in study_type_options %}
            <option value="{{ opt }}" {% if study.study_type==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Fecha y centro -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="date" class="form-label">Fecha del estudio</label>
            <input type="date" class="form-control" name="date" id="date" value="{{ study.date or '' }}">
          </div>
          <div class="col-md-6">
            <label for="center" class="form-label">Centro</label>
            <select name="center" id="center" class="form-select">
              <option value="">-- Seleccionar --</option>
              {% for c in center_options %}
              <option value="{{ c }}" {% if study.center==c %}selected{% endif %}>{{ c }}</option>
              {% endfor %}
            </select>
            <input
              type="text"
              class="form-control mt-2"
              name="center_text"
              placeholder="Ej: Hospital Pasteur"
              value="{{ study.center or '' }}"
            >
          </div>
        </div>

        <!-- Acceso y link (solo imágenes) -->
        <div class="mb-3">
          <label for="access_code" class="form-label">Número de acceso (solo imágenes)</label>
          <input
            type="text"
            class="form-control"
            name="access_code"
            id="access_code"
            value="{{ study.access_code or '' }}"
          >
        </div>

        <div class="mb-3">
          <label for="portal_link" class="form-label">Link de acceso directo (solo imágenes)</label>
          <input
            type="url"
            class="form-control"
            name="portal_link"
            id="portal_link"
            value="{{ study.portal_link or '' }}"
            placeholder="Ej: https://portal.com/estudio/123"
          >
        </div>

        <!-- PDF -->
        <div class="mb-3">
          <label class="form-label">Subir informe (PDF)</label>
          <input type="file" class="form-control" name="study_file" accept="application/pdf">
          {% if study.report_file %}
          <p class="mt-2">
            Archivo actual:
            <a href="{{ url_for('study_download', study_id=study.id) }}" target="_blank">
              {{ study.report_file }}
            </a>
          </p>
          {% endif %}
        </div>

        <!-- Descripción -->
        <div class="mb-3">
          <label for="description" class="form-label">Descripción / hallazgos</label>
          <textarea name="description" id="description" rows="4" class="form-control">{{ study.description or '' }}</textarea>
        </div>

        <!-- Control -->
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" value="1" id="request_review" name="request_review">
          <label class="form-check-label" for="request_review">
            Solicitar control (recordatorio)
          </label>
        </div>

        <button type="submit" class="btn btn-primary">Guardar</button>
        <a href="{{ url_for('patient_detail', patient_id=study.patient_id) }}" class="btn btn-secondary">Cancelar</a>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<h1>Editar estudio</h1>

<p>
  <strong>Paciente:</strong> {{ patient.full_name }}
  {% if patient.dni %}(DNI: {{ patient.dni }}){% endif %}
</p>

<form method="post" enctype="multipart/form-data">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="form-section">
    <h2>Datos del estudio</h2>

    <label for="study_type">Tipo de estudio</label>
    <select id="study_type" name="study_type">
      <option value="">-- Seleccionar --</option>
      {% for option in study_type_options %}
        <option value="{{ option }}" {% if study.study_type == option %}selected{% endif %}>{{ option }}</option>
      {% endfor %}
    </select>

    <div class="grid-2">
      <div>
        <label for="date">Fecha del estudio</label>
        <input type="date" id="date" name="date" value="{{ study.date or '' }}">
      </div>
      <div>
        <label for="center_select">Centro</label>
        <select id="center_select">
          <option value="">-- Seleccionar --</option>
          {% for c in center_options %}
            <option value="{{ c }}" {% if study.center == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
          <option value="__otro__" {% if study.center and study.center not in center_options %}selected{% endif %}>Otro</option>
        </select>
        <input type="text" id="center" name="center" value="{{ study.center or '' }}" placeholder="Ej: Hospital Pasteur">
        <p id="center-link"></p>
      </div>
    </div>

    <label for="description">Descripción / hallazgos</label>
    <div class="voice-field">
      <textarea id="description" name="description" rows="4">{{ study.description or '' }}</textarea>
      <button type="button" class="btn-link btn-secondary" data-voice-btn data-target="description">Dictado</button>
    </div>

    <label for="access_code">Número de acceso</label>
    <input type="text" id="access_code" name="access_code" value="{{ study.access_code or '' }}">

    <label>Subir informe (PDF)</label>
    <input type="file" name="study_file" accept="application/pdf">
    {% if study.report_file %}
      <p>
        Archivo actual:
        <a href="{{ url_for('study_download', study_id=study.id) }}">Descargar</a>
      </p>
    {% endif %}
  </div>

  <button type="submit">Guardar cambios</button>
  <a class="btn-link btn-secondary" href="{{ url_for('patient_detail', patient_id=patient.id) }}">Cancelar</a>
</form>

<script>
  (function() {
    const links = {{ center_links|tojson }};
    const select = document.getElementById('center_select');
    const input = document.getElementById('center');
    const display = document.getElementById('center-link');

    function updateLink() {
      if (!input || !display) return;
      const value = (input.value || '').trim().toLowerCase();
      const url = links[value] || '';
      display.innerHTML = url ? 'Portal: <a href="' + url + '" target="_blank">' + url + '</a>' : '';
    }

    function syncCenter() {
      if (!select || !input) return;
      if (select.value && select.value !== '__otro__') {
        input.value = select.value;
        input.readOnly = true;
      } else if (select.value === '__otro__') {
        input.readOnly = false;
        if (!input.value) input.value = '';
        input.focus();
      } else {
        input.readOnly = false;
      }
      updateLink();
    }

    if (select) {
      select.addEventListener('change', syncCenter);
      syncCenter();
    }
    if (input) {
      input.addEventListener('input', updateLink);
      updateLink();
    }
  })();
</script>
{% endblock %}


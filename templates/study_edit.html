{% extends "base.html" %}
{% import "_study_form_macros.html" as sm %}

{% block content %}
<div class="container my-4">
  
  <div class="form-section">
    <h2>Paciente</h2>
    <p class="mb-1">
      <strong>{{ patient.full_name }}</strong> — DNI: <strong>{{ patient.dni or "—" }}</strong>
    </p>
  </div>

  <form method="post" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="form-section">
      <h2>Editar estudio {% if app_version %}<small style="float:right; font-size:12px; color:#6c757d;">v{{ app_version }}</small>{% endif %}</h2>
      
      <!-- Detectar grupo del estudio actual - case insensitive -->
      {% set study_type_lower = (study.study_type or '')|lower %}
      {% set current_group = 'other' %}
      {% if study_type_lower in ['espirometría', 'test de la marcha 6m', 'dlco', 'volúmenes pulmonares'] %}
        {% set current_group = 'func' %}
      {% elif ('tc' in study_type_lower or 'rm' in study_type_lower or 'pet' in study_type_lower or 'rx' in study_type_lower or 'ecografia' in study_type_lower or 'ecocardiograma' in study_type_lower or 'ecodoppler' in study_type_lower) %}
        {% set current_group = 'img' %}
      {% elif study_type_lower in ['fibrobroncoscopía', 'biopsia', 'bal', 'otro'] %}
        {% set current_group = 'inv' %}
      {% endif %}
      
      {# Etiquetas alineadas a la UI de consulta #}
      {{ sm.type_and_date_row(current_group, 'study_type', 'date', study.study_type, study.date, study_type_options) }}

      <!-- Mostrar centro, acceso y link solo si es grupo imagen -->
      {% if current_group == 'img' %}
      {{ sm.image_center_row('center', study.center, center_options) }}
      {{ sm.image_access_link_row('access_code', study.access_code, 'portal_link', study.portal_link) }}
      {% endif %}

      <div class="form-group">
        <label for="description">Descripción / hallazgos</label>
        <textarea id="description" name="description" class="form-control" rows="3">{{ study.description or '' }}</textarea>
        <button type="button" class="btn btn-secondary btn-sm mt-2" data-voice-btn data-target="description">Dictado</button>
      </div>

      <div class="form-group">
        <label for="study_file">Subir informe (PDF)</label>
        <input id="study_file" type="file" name="study_file" accept="application/pdf" class="form-control">
        {% if study.report_file %}
        <small class="form-text text-muted d-block mt-2">
          Archivo actual: <a href="{{ url_for('study_download', study_id=study.id) }}" target="_blank">{{ study.report_file }}</a>
        </small>
        {% endif %}
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="d-flex justify-content-between mb-4 gap-2 flex-wrap">
      <div>
        <button type="submit" class="btn btn-primary" name="action" value="">Guardar cambios</button>
        <a class="btn btn-link" href="{{ url_for('patient_detail', patient_id=patient.id) }}">Cancelar</a>
      </div>
      <div>
        <button type="submit" class="btn btn-primary btn-sm" name="action" value="add_study">Agregar estudio</button>
        <button type="submit" class="btn btn-outline-danger btn-sm" name="action" value="delete" onclick="return confirm('¿Estás seguro de que deseas eliminar este estudio?')">Eliminar</button>
      </div>
    </div>
  </form>
</div>

<style>.d-none{display:none!important;}</style>
<script>
  // Portal link display para estudios de imagen
  const centerLinks = {
    {% for name, url in center_links.items() %}
    "{{ name|lower }}": "{{ url }}",
    {% endfor %}
  };

  function updatePortalLink(centerSelect) {
    const linkDisplay = document.querySelector('.center-link-display');
    if (!centerSelect || !linkDisplay) return;

    const selectedCenter = centerSelect.value.toLowerCase();
    const url = centerLinks[selectedCenter];
    if (url) {
      linkDisplay.innerHTML = 'Portal: <a href="' + url + '" target="_blank">' + url + '</a>';
      linkDisplay.style.display = 'block';
    } else {
      linkDisplay.style.display = 'none';
    }
  }

  // Al cambiar el centro (coincidir por nombre según macro)
  document.addEventListener('change', (ev) => {
    const centerSelect = ev.target.closest('select[name="center"]');
    if (centerSelect) {
      updatePortalLink(centerSelect);
    }
  });

  // Ejecutar al cargar la página para mostrar link si ya hay centro seleccionado
  document.addEventListener("DOMContentLoaded", () => {
    const centerSelect = document.querySelector('select[name="center"]');
    if (centerSelect && centerSelect.value) {
      updatePortalLink(centerSelect);
    }
  });
</script>
{% endblock %}

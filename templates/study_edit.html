{% extends "base.html" %}

{% block content %}
<div class="container my-4">
  
  <div class="form-section">
    <h2>Paciente</h2>
    <p class="mb-1">
      <strong>{{ patient.full_name }}</strong> — DNI: <strong>{{ patient.dni or "—" }}</strong>
    </p>
  </div>

  <form method="post" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="form-section">
      <h2>Editar estudio</h2>
      
      <!-- Detectar grupo del estudio actual - case insensitive -->
      {% set study_type_lower = (study.study_type or '')|lower %}
      {% set current_group = 'other' %}
      {% if study_type_lower in ['espirometría', 'test de la marcha 6m', 'dlco', 'volúmenes pulmonares'] %}
        {% set current_group = 'func' %}
      {% elif ('tc' in study_type_lower or 'rm' in study_type_lower or 'pet' in study_type_lower or 'rx' in study_type_lower or 'ecografia' in study_type_lower or 'ecocardiograma' in study_type_lower or 'ecodoppler' in study_type_lower) %}
        {% set current_group = 'img' %}
      {% elif study_type_lower in ['fibrobroncoscopía', 'biopsia', 'bal', 'otro'] %}
        {% set current_group = 'inv' %}
      {% endif %}
      
      <div class="form-group">
        <label for="study_type">Tipo de estudio</label>
        <select id="study_type" name="study_type" class="form-control">
          <option value="">-- Seleccionar --</option>
          {% if current_group == 'func' %}
            <option value="Espirometría" {% if study.study_type=='Espirometría' %}selected{% endif %}>Espirometría</option>
            <option value="Test de la Marcha 6m" {% if study.study_type=='Test de la Marcha 6m' %}selected{% endif %}>Test de la Marcha 6m</option>
            <option value="DLCO" {% if study.study_type=='DLCO' %}selected{% endif %}>DLCO</option>
            <option value="Volúmenes pulmonares" {% if study.study_type=='Volúmenes pulmonares' %}selected{% endif %}>Volúmenes pulmonares</option>
          {% elif current_group == 'img' %}
            <option value="TC Tórax" {% if study.study_type=='TC Tórax' %}selected{% endif %}>TC Tórax</option>
            <option value="RM Tórax" {% if study.study_type=='RM Tórax' %}selected{% endif %}>RM Tórax</option>
            <option value="PET-CT" {% if study.study_type=='PET-CT' %}selected{% endif %}>PET-CT</option>
            <option value="RX" {% if study.study_type=='RX' %}selected{% endif %}>RX</option>
            <option value="Ecografía" {% if study.study_type=='Ecografía' %}selected{% endif %}>Ecografía</option>
            <option value="Ecocardiograma" {% if study.study_type=='Ecocardiograma' %}selected{% endif %}>Ecocardiograma</option>
            <option value="Ecodoppler Angiopower" {% if study.study_type=='Ecodoppler Angiopower' %}selected{% endif %}>Ecodoppler Angiopower</option>
          {% elif current_group == 'inv' %}
            <option value="Fibrobroncoscopía" {% if study.study_type=='Fibrobroncoscopía' %}selected{% endif %}>Fibrobroncoscopía</option>
            <option value="Biopsia" {% if study.study_type=='Biopsia' %}selected{% endif %}>Biopsia</option>
            <option value="BAL" {% if study.study_type=='BAL' %}selected{% endif %}>BAL</option>
            <option value="Otro" {% if study.study_type=='Otro' %}selected{% endif %}>Otro</option>
          {% else %}
            <!-- Mostrar todas las opciones si no es ninguno de los grupos -->
            {% for opt in study_type_options %}
            <option value="{{ opt }}" {% if study.study_type==opt %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>

      <div class="form-group">
        <label for="date">Fecha del estudio</label>
        <input id="date" name="date" type="date" class="form-control" value="{{ study.date or '' }}">
      </div>

      <!-- Mostrar centro, acceso y link solo si es grupo imagen -->
      {% if current_group == 'img' %}
      <div class="form-group">
        <label for="center">Centro</label>
        <select id="center" name="center" class="form-control">
          <option value="">-- Seleccionar --</option>
          {% for c in center_options %}
          <option value="{{ c }}" {% if study.center==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
        <small class="center-link-display form-text text-muted" style="display:none;"></small>
      </div>

      <div class="form-group">
        <label for="access_code">Número de acceso</label>
        <input id="access_code" name="access_code" type="text" class="form-control" value="{{ study.access_code or '' }}">
      </div>

      <div class="form-group">
        <label for="portal_link">Link de ingreso directo</label>
        <input id="portal_link" name="portal_link" type="url" class="form-control" value="{{ study.portal_link or '' }}">
      </div>
      {% endif %}

      <div class="form-group">
        <label for="description">Descripción / hallazgos</label>
        <textarea id="description" name="description" class="form-control" rows="3">{{ study.description or '' }}</textarea>
        <button type="button" class="btn btn-secondary btn-sm mt-2" data-voice-btn data-target="description">Dictado</button>
      </div>

      <div class="form-group">
        <label for="study_file">Subir informe (PDF)</label>
        <input id="study_file" type="file" name="study_file" accept="application/pdf" class="form-control">
        {% if study.report_file %}
        <small class="form-text text-muted d-block mt-2">
          Archivo actual: <a href="{{ url_for('study_download', study_id=study.id) }}" target="_blank">{{ study.report_file }}</a>
        </small>
        {% endif %}
      </div>
    </div>

    <div class="d-flex justify-content-between mb-4">
      <button type="submit" class="btn btn-primary">Guardar cambios</button>
      <a class="btn btn-link" href="{{ url_for('patient_detail', patient_id=patient.id) }}">Cancelar</a>
    </div>
  </form>
</div>

<style>.d-none{display:none!important;}</style>
<script>
  // Portal link display para estudios de imagen
  const centerLinks = {
    {% for name, url in center_links.items() %}
    "{{ name|lower }}": "{{ url }}",
    {% endfor %}
  };

  function updatePortalLink(centerSelect) {
    const linkDisplay = document.querySelector('.center-link-display');
    if (!centerSelect || !linkDisplay) return;
    
    const selectedCenter = centerSelect.value.toLowerCase();
    const url = centerLinks[selectedCenter];
    if (url) {
      linkDisplay.innerHTML = 'Portal: <a href="' + url + '" target="_blank">' + url + '</a>';
      linkDisplay.style.display = 'block';
    } else {
      linkDisplay.style.display = 'none';
    }
  }

  // Al cambiar el centro
  document.addEventListener('change', (ev) => {
    const centerSelect = ev.target.closest('select#center');
    if (centerSelect) {
      updatePortalLink(centerSelect);
    }
  });

  // Ejecutar al cargar la página para mostrar link si ya hay centro seleccionado
  document.addEventListener("DOMContentLoaded", () => {
    const centerSelect = document.getElementById('center');
    if (centerSelect && centerSelect.value) {
      updatePortalLink(centerSelect);
    }
  });
</script>
{% endblock %}

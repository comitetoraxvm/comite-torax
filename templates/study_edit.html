{% extends "base.html" %}

{% block content %}
<div class="container my-4">
  <h3 class="mb-3">Editar estudio</h3>
  <p><strong>Paciente:</strong> {{ patient.full_name }} (DNI: {{ patient.dni or "—" }})</p>

  <form method="post" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Datos del estudio</h5>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label for="study_type">Tipo de estudio</label>
            <select id="study_type" name="study_type" class="form-control">
              <option value="">-- Seleccionar --</option>
              {% for opt in study_type_options %}
              <option value="{{ opt }}" {% if study.study_type==opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group col-md-6">
            <label for="date">Fecha del estudio</label>
            <input id="date" name="date" type="date" class="form-control" value="{{ study.date or '' }}">
          </div>
        </div>

        <div class="form-group">
          <label for="center">Centro</label>
          <select id="center" name="center" class="form-control">
            <option value="">-- Seleccionar --</option>
            {% for c in center_options %}
            <option value="{{ c }}" {% if study.center==c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
          <small class="form-text text-muted">Ej: Hospital Pasteur</small>
        </div>

        <div class="form-group">
          <label for="access_code">Número de acceso</label>
          <input id="access_code" name="access_code" type="text" class="form-control" value="{{ study.access_code or '' }}">
        </div>
        <div class="form-group">
          <label for="portal_link">Link de ingreso directo</label>
          <input id="portal_link" name="portal_link" type="url" class="form-control" value="{{ study.portal_link or '' }}">
        </div>

        <div class="form-group">
          <label for="description">Descripción / hallazgos</label>
          <textarea id="description" name="description" class="form-control" rows="3">{{ study.description or '' }}</textarea>
          <button type="button" class="btn btn-secondary btn-sm mt-2">Dictado</button>
        </div>

        <div class="form-group">
          <label for="study_file">Subir informe (PDF)</label>
          <input id="study_file" type="file" name="study_file" accept="application/pdf">
          {% if study.report_file %}
          <small class="form-text text-muted">Archivo actual: {{ study.report_file }}</small>
          {% endif %}
        </div>

        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="control-enabled" name="control_enabled">
          <label class="form-check-label" for="control-enabled">Solicitar control (recordatorio)</label>
        </div>
        <div id="control-fields" class="form-row d-none">
          <div class="form-group col-md-4">
            <label for="control-date">Fecha de control</label>
            <input id="control-date" name="control_date" type="date" class="form-control">
          </div>
          <div class="form-group col-md-8">
            <label for="control-extra">Emails adicionales</label>
            <input id="control-extra" name="control_extra_emails" type="text" class="form-control" placeholder="Correos separados por coma">
          </div>
        </div>

      </div>
    </div>

    <div class="d-flex justify-content-between mb-4">
      <button type="submit" class="btn btn-primary">Guardar</button>
      <a class="btn btn-link" href="{{ url_for('patient_detail', patient_id=patient.id) }}">Cancelar</a>
    </div>
  </form>
</div>

<style>.d-none{display:none!important;}</style>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const chk = document.getElementById("control-enabled");
  const blk = document.getElementById("control-fields");
  if(chk && blk){
    chk.addEventListener("change",()=>blk.classList.toggle("d-none",!chk.checked));
  }
});
</script>
{% endblock %}

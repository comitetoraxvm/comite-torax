{% extends "base.html" %}
{% block content %}
<div class="container my-4">
  <h3 class="mb-3">Nueva consulta</h3>
  <form method="post" enctype="multipart/form-data">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- Cabecera paciente -->
    <div class="card mb-3">
      <div class="card-body">
        <p class="mb-1"><strong>Paciente:</strong> {{ patient.full_name }} — <strong>DNI:</strong> {{ patient.dni or '' }}</p>
      </div>
    </div>

    <!-- Datos de la consulta -->
    <div class="card mb-3">
      <div class="card-body">
        <h5>Datos de la consulta</h5>
        <div class="mb-3">
          <label class="form-label">Fecha de la consulta *</label>
          <input type="date" class="form-control" name="date" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Notas</label>
          <textarea class="form-control" name="notes" rows="3"></textarea>
        </div>
        <button type="button" class="btn btn-secondary btn-sm">Dictado</button>
      </div>
    </div>

    <!-- Estudio asociado -->
    <div class="card mb-3">
      <div class="card-body">
        <h5>Estudio asociado</h5>
        <p>Elige el grupo y completa solo ese bloque. Puedes seleccionar más de uno si corresponde.</p>

        <div class="form-check">
          <input class="form-check-input study-group" type="checkbox" id="grp-func" value="func">
          <label class="form-check-label" for="grp-func">Pruebas funcionales respiratorias</label>
        </div>
        <div class="form-check">
          <input class="form-check-input study-group" type="checkbox" id="grp-img" value="img">
          <label class="form-check-label" for="grp-img">Diagnóstico por imágenes</label>
        </div>
        <div class="form-check">
          <input class="form-check-input study-group" type="checkbox" id="grp-inv" value="inv">
          <label class="form-check-label" for="grp-inv">Procedimientos invasivos</label>
        </div>

        <div id="study-block" class="mt-3 d-none">
          <div class="mb-2">
            <label class="form-label">Tipo de estudio</label>
            <select class="form-select" name="study_type">
              <option value="">-- Seleccionar --</option>
              {% for opt in study_type_options %}
              <option value="{{ opt }}">{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Fecha del estudio</label>
              <input type="date" class="form-control" name="study_date">
            </div>
            <div class="col-md-6" id="center-wrapper">
              <label class="form-label">Centro</label>
              <select class="form-select" name="study_center">
                <option value="">-- Seleccionar --</option>
                {% for c in center_options %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
              <small class="text-muted">Ej: Hospital Pasteur</small>
            </div>
          </div>
          <div class="row g-2 mt-2" id="access-wrapper">
            <div class="col-md-6">
              <label class="form-label">Número de acceso</label>
              <input type="text" class="form-control" name="study_access_code">
            </div>
            <div class="col-md-6">
              <label class="form-label">Link de ingreso directo</label>
              <input type="url" class="form-control" name="study_portal_link">
            </div>
          </div>

          <a class="btn btn-secondary btn-sm my-2" href="https://ae.connect.boehringer-ingelheim.com/c/eJx0klFv2yAQxz8NfkuFzwY7D35w63iL1JdWytY-RRjOCSoGBnaX7dNPOFPWPdSyTsD97v7cX7xsHsWApiHVPQHwwalFzntFAEjREgBBqaLrpxDdoW2fUgoeCEBAqb1GO_-DDV50_C2sCto6UtLTJLS5k266FQnvg3tHtUuZjzoQD_tV5_HL62V6bb_eSvAyY7DiRtvFmGtmiRg-9KCU0e9rD_7Wupen9nDr4cLpP7D7OxQdn9m33RWsukw1uFVQbTNs8qpkDGhVsuzc1KymwFLMVbllaqhz5HwUkvOBjQXPdAMUGC2hzGsGwO7Gmo1DwYcEKFpVpKTSWYtyvhscnoO2JwybFM0Z9ZQ8ykxznmcf1zv2BHof3KcwgT4KAr0IBHopjFyMUC6IjcKND-4UMGpnr7sFBxHTclysTKd-MZOzImxEIEUvtSJF1-6S7vqvo0AOBPj9ft-RoqM0vxqWyx-Hnw9tMow7v6S6ZwJ80EeF6I22b8eIMUkfh19exEiKLs9C8_nLyN4b-BMAAP__3uHA8g" target="_blank">Calculadora de progresión…</a>

          <div class="mb-2">
            <label class="form-label">Descripción / hallazgos</label>
            <textarea class="form-control" name="study_description" rows="3"></textarea>
          </div>
          <button type="button" class="btn btn-secondary btn-sm mb-2">Dictado</button>

          <div class="mb-2" id="pdf-wrapper">
            <label class="form-label">Subir informe (PDF)</label>
            <input type="file" class="form-control" name="study_file" accept=".pdf">
          </div>

          <div class="form-check mb-2" id="control-wrapper">
            <input class="form-check-input" type="checkbox" name="control_enabled" id="ctrl-enabled">
            <label class="form-check-label" for="ctrl-enabled">Solicitar control (recordatorio)</label>
          </div>
          <div class="row g-2" id="control-fields">
            <div class="col-md-4">
              <label class="form-label">Fecha de control</label>
              <input type="date" class="form-control" name="control_date">
            </div>
            <div class="col-md-8">
              <label class="form-label">Emails adicionales (separar con coma)</label>
              <input type="text" class="form-control" name="control_extra_emails">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Laboratorio -->
    <div class="card mb-3">
      <div class="card-body">
        <h5>Laboratorio</h5>
        <div class="mb-2">
          <label class="form-label">Laboratorio general</label>
          <textarea class="form-control" name="lab_general" rows="2"></textarea>
        </div>
        <button type="button" class="btn btn-secondary btn-sm mb-3">Dictado</button>

        <h6>Autoinmunidad</h6>
        <div class="row row-cols-1 row-cols-md-2 g-2">
          {% for code,label in immuno_options %}
          <div class="col">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="lab_immunology" value="{{ code }}" id="lab_{{ code }}">
              <label class="form-check-label" for="lab_{{ code }}">{{ label }}</label>
              <input type="text" class="form-control form-control-sm mt-1" name="lab_immunology_value_{{ code }}" placeholder="Valor">
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="toggle-rheum">
          <label class="form-check-label" for="toggle-rheum">Panel ampliado (reumatología)</label>
        </div>
        <div id="rheum-panel" class="d-none mt-2">
          {% for code,label in immuno_rheum_options %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="lab_immunology" value="{{ code }}" id="rhe_{{ code }}">
            <label class="form-check-label" for="rhe_{{ code }}">{{ label }}</label>
            <input type="text" class="form-control form-control-sm mt-1" name="lab_immunology_value_{{ code }}" placeholder="Valor">
          </div>
          {% endfor %}
        </div>
        <div class="mt-2">
          <label class="form-label">Nota autoinmunidad</label>
          <textarea class="form-control" name="lab_immunology_notes" rows="2"></textarea>
        </div>
        <button type="button" class="btn btn-secondary btn-sm mt-2">Dictado</button>
      </div>
    </div>

    <!-- Revisión -->
    <div class="card mb-3">
      <div class="card-body">
        <h5>Revisión</h5>
        <div class="mb-2">
          <label class="form-label">Selecciona colegas para revisar</label>
          <select class="form-select" name="review_recipients" multiple>
            {% for u in review_users %}
            <option value="{{ u.id }}">{{ u.full_name }} ({{ u.email }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Mensaje</label>
          <textarea class="form-control" name="review_message" rows="2"></textarea>
        </div>
        <button type="button" class="btn btn-secondary btn-sm">Dictado</button>
      </div>
    </div>

    <div class="d-flex gap-2 mb-3">
      <button type="submit" class="btn btn-primary">Guardar consulta</button>
      <a class="btn btn-link" href="{{ url_for('patient_detail', patient_id=patient.id) }}">Cancelar</a>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const block = document.getElementById("study-block");
  const centerWrap = document.getElementById("center-wrapper");
  const accessWrap = document.getElementById("access-wrapper");
  const ctrlWrap = document.getElementById("control-wrapper");
  const ctrlFields = document.getElementById("control-fields");
  const rheum = document.getElementById("rheum-panel");
  const toggleRheum = document.getElementById("toggle-rheum");
  const radios = document.querySelectorAll(".study-group");
  const ctrlChk = document.getElementById("ctrl-enabled");

  function updateVisibility() {
    const sel = Array.from(radios).filter(r => r.checked).map(r => r.value);
    if (sel.length) block.classList.remove("d-none"); else block.classList.add("d-none");
    const showImg = sel.includes("img");
    centerWrap.classList.toggle("d-none", !showImg);
    accessWrap.classList.toggle("d-none", !showImg);
    const noCtrl = sel.includes("inv");
    ctrlWrap.classList.toggle("d-none", noCtrl);
    ctrlFields.classList.toggle("d-none", noCtrl || !ctrlChk.checked);
  }
  radios.forEach(r => r.addEventListener("change", updateVisibility));
  ctrlChk.addEventListener("change", updateVisibility);
  toggleRheum.addEventListener("change", () => rheum.classList.toggle("d-none", !toggleRheum.checked));
});
</script>
{% endblock %}

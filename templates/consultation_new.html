{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Nueva consulta</h2>
  <p><strong>Paciente:</strong> {{ patient.full_name }}{% if patient.dni %} | DNI: {{ patient.dni }}{% endif %}</p>

  <form method="post" enctype="multipart/form-data">
    <!-- Datos básicos -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Fecha de la consulta</label>
            <input type="date" name="date" class="form-control" required>
          </div>
          <div class="col-md-8">
            <label class="form-label">Notas</label>
            <div class="input-group">
              <textarea name="notes" rows="2" class="form-control"></textarea>
              <button type="button" class="btn btn-secondary voice-btn" data-target="[name='notes']">Dictado</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Estudios asociados -->
    <div class="card mb-4">
      <div class="card-body">
        <h4>Estudio asociado</h4>
        <p>Elige el grupo y completa solo ese bloque. Puedes agregar más de un estudio dentro del mismo grupo.</p>

        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="study_group" id="grp_func" value="func" checked>
            <label class="form-check-label" for="grp_func">PRUEBAS FUNCIONALES RESPIRATORIAS</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="study_group" id="grp_img" value="img">
            <label class="form-check-label" for="grp_img">DIAGNÓSTICO POR IMÁGENES</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="study_group" id="grp_inv" value="inv">
            <label class="form-check-label" for="grp_inv">PROCEDIMIENTOS INVASIVOS</label>
          </div>
        </div>

        <!-- Funcionales -->
        <div id="section-func">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Pruebas funcionales</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRow('func')">Agregar estudio</button>
          </div>
          <div id="func-rows" class="mb-3"></div>

          <button type="button" class="btn btn-secondary mb-3" onclick="openCalculator()">Calculadora de progresión de pruebas de función pulmonar</button>

          <div class="mb-3">
            <label class="form-label">Descripción / hallazgos (compartida)</label>
            <div class="input-group">
              <textarea name="func_description" rows="3" class="form-control"></textarea>
              <button type="button" class="btn btn-secondary voice-btn" data-target="[name='func_description']">Dictado</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Subir informe (PDF) (compartido)</label>
            <input type="file" name="func_file" accept="application/pdf" class="form-control">
          </div>
          <div class="mb-3">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" name="func_control_enabled" id="func_control_enabled" onclick="toggleControl('func')">
              <label class="form-check-label" for="func_control_enabled">Solicitar control (recordatorio)</label>
            </div>
            <div id="func-control-fields" class="row g-2" style="display:none">
              <div class="col-md-4">
                <label class="form-label">Fecha de control</label>
                <input type="date" name="func_control_date" class="form-control">
              </div>
              <div class="col-md-8">
                <label class="form-label">Emails adicionales (separados por coma)</label>
                <input type="text" name="func_control_extra_emails" class="form-control">
              </div>
            </div>
          </div>
          <hr>
        </div>

        <!-- Imágenes -->
        <div id="section-img" style="display:none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Diagnóstico por imágenes</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRow('img')">Agregar estudio</button>
          </div>
          <div id="img-rows" class="mb-3"></div>

          <div class="mb-3">
            <label class="form-label">Subir informe (PDF) (compartido)</label>
            <input type="file" name="img_file" accept="application/pdf" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Descripción / hallazgos (compartida)</label>
            <div class="input-group">
              <textarea name="img_description" rows="3" class="form-control"></textarea>
              <button type="button" class="btn btn-secondary voice-btn" data-target="[name='img_description']">Dictado</button>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" name="img_control_enabled" id="img_control_enabled" onclick="toggleControl('img')">
              <label class="form-check-label" for="img_control_enabled">Solicitar control (recordatorio)</label>
            </div>
            <div id="img-control-fields" class="row g-2" style="display:none">
              <div class="col-md-4">
                <label class="form-label">Fecha de control</label>
                <input type="date" name="img_control_date" class="form-control">
              </div>
              <div class="col-md-8">
                <label class="form-label">Emails adicionales (separados por coma)</label>
                <input type="text" name="img_control_extra_emails" class="form-control">
              </div>
            </div>
          </div>
          <hr>
        </div>

        <!-- Invasivos -->
        <div id="section-inv" style="display:none">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Procedimientos invasivos</h5>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addRow('inv')">Agregar estudio</button>
          </div>
          <div id="inv-rows" class="mb-3"></div>

          <div class="mb-3">
            <label class="form-label">Subir informe (PDF) (compartido)</label>
            <input type="file" name="inv_file" accept="application/pdf" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Descripción / hallazgos (compartida)</label>
            <div class="input-group">
              <textarea name="inv_description" rows="3" class="form-control"></textarea>
              <button type="button" class="btn btn-secondary voice-btn" data-target="[name='inv_description']">Dictado</button>
            </div>
          </div>
        </div>

        <!-- Revisiones -->
        <hr>
        <h5>Revisión</h5>
        <div class="mb-3">
          <label class="form-label">Destinatarios</label>
          <select name="review_recipients" class="form-select" multiple size="4">
            {% for u in review_users %}
            <option value="{{ u.id }}">{{ u.full_name }} ({{ u.email }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Mensaje para revisión</label>
          <div class="input-group">
            <textarea name="review_message" rows="2" class="form-control"></textarea>
            <button type="button" class="btn btn-secondary voice-btn" data-target=\"[name='review_message']\">Dictado</button>
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Guardar consulta</button>
        <a href="{{ url_for('patient_detail', patient_id=patient.id) }}" class="btn btn-secondary">Cancelar</a>
      </div>
    </div>
  </form>
</div>

<!-- Templates para filas -->
<template id="tpl-func">
  <div class="row g-3 align-items-end mb-2 func-row">
    <div class="col-md-6">
      <label class="form-label">Tipo de estudio</label>
      <select name="func_type[]" class="form-select">
        <option value="">-- Seleccionar --</option>
        {% for opt in study_type_options %}
        <option value="{{ opt }}">{{ opt }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Fecha</label>
      <input type="date" name="func_date[]" class="form-control">
    </div>
    <div class="col-md-2">
      <button type="button" class="btn btn-outline-danger w-100" onclick="removeRow(this)">Eliminar</button>
    </div>
  </div>
</template>

<template id="tpl-img">
  <div class="row g-3 align-items-end mb-2 img-row">
    <div class="col-md-6">
      <label class="form-label">Tipo de estudio</label>
      <select name="img_type[]" class="form-select">
        <option value="">-- Seleccionar --</option>
        {% for opt in study_type_options %}
        <option value="{{ opt }}">{{ opt }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">Fecha</label>
      <input type="date" name="img_date[]" class="form-control">
    </div>
    <div class="col-md-6">
      <label class="form-label mt-2">Centro</label>
      <select name="img_center[]" class="form-select">
        <option value="">-- Seleccionar --</option>
        {% for c in center_options %}
        <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label mt-2">Número de acceso</label>
      <input type="text" name="img_access[]" class="form-control" placeholder="Ej: 123456">
    </div>
    <div class="col-12">
      <label class="form-label mt-2">Link de acceso directo</label>
      <input type="url" name="img_link[]" class="form-control" placeholder="Ej: https://portal.com/estudio/123">
    </div>
    <div class="col-md-2">
      <button type="button" class="btn btn-outline-danger w-100 mt-2" onclick="removeRow(this)">Eliminar</button>
    </div>
  </div>
</template>

<template id="tpl-inv">
  <div class="row g-3 align-items-end mb-2 inv-row">
    <div class="col-md-6">
      <label class="form-label">Tipo de estudio</label>
      <select name="inv_type[]" class="form-select">
        <option value="">-- Seleccionar --</option>
        {% for opt in study_type_options %}
        <option value="{{ opt }}">{{ opt }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Fecha</label>
      <input type="date" name="inv_date[]" class="form-control">
    </div>
    <div class="col-md-2">
      <button type="button" class="btn btn-outline-danger w-100" onclick="removeRow(this)">Eliminar</button>
    </div>
  </div>
</template>

{% block scripts %}
{{ super() }}
<script>
  function switchGroup(val) {
    document.getElementById('section-func').style.display = (val === 'func') ? 'block' : 'none';
    document.getElementById('section-img').style.display  = (val === 'img')  ? 'block' : 'none';
    document.getElementById('section-inv').style.display  = (val === 'inv')  ? 'block' : 'none';
  }

  function addRow(group) {
    const tpl = document.getElementById(`tpl-${group}`);
    if (!tpl) return;
    const clone = tpl.content.cloneNode(true);
    document.getElementById(`${group}-rows`).appendChild(clone);
  }

  function removeRow(btn) {
    const row = btn.closest('.row');
    if (row) row.remove();
  }

  function toggleControl(group) {
    const cb = document.getElementById(`${group}_control_enabled`);
    const box = document.getElementById(`${group}-control-fields`);
    if (box) box.style.display = cb && cb.checked ? 'flex' : 'none';
  }

  function openCalculator() {
    window.open("https://ae.connect.boehringer-ingelheim.com/c/eJx0klFv2yAQxz8NfkuFzwY7D35w63iL1JdWytY-RRjOCSoGBnaX7dNPOFPWPdSyTsD97v7cX7xsHsWApiHVPQHwwalFzntFAEjREgBBqaLrpxDdoW2fUgoeCEBAqb1GO_-DDV50_C2sCto6UtLTJLS5k266FQnvg3tHtUuZjzoQD_tV5_HL62V6bb_eSvAyY7DiRtvFmGtmiRg-9KCU0e9rD_7Wupen9nDr4cLpP7D7OxQdn9m33RWsukw1uFVQbTNs8qpkDGhVsuzc1KymwFLMVbllaqhz5HwUkvOBjQXPdAMUGC2hzGsGwO7Gmo1DwYcEKFpVpKTSWYtyvhscnoO2JwybFM0Z9ZQ8ykxznmcf1zv2BHof3KcwgT4KAr0IBHopjFyMUC6IjcKND-4UMGpnr7sFBxHTclysTKd-MZOzImxEIEUvtSJF1-6S7vqvo0AOBPj9ft-RoqM0vxqWyx-Hnw9tMow7v6S6ZwJ80EeF6I22b8eIMUkfh19exEiKLs9C8_nLyN4b-BMAAP__3uHA8g", "_blank");
  }

  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll("input[name='study_group']").forEach(r => {
      r.addEventListener("change", e => switchGroup(e.target.value));
    });
    const checked = document.querySelector("input[name='study_group']:checked");
    switchGroup(checked ? checked.value : 'func');
    addRow('func');
    addRow('img');
    addRow('inv');
    toggleControl('func');
    toggleControl('img');
  });
</script>
{% endblock %}
{% endblock %}
